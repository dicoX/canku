var queryConditions={matchCon:""},SYSTEM=parent.SYSTEM,VERSION=parent.SYSTEM.siType;var THISPAGE={init:function(a){this.mod_PageConfig=Public.mod_PageConfig.init("verificationList");this.initDom();this.loadGrid();this.addEvent();},initDom:function(){this.$_matchCon=$("#matchCon");this.$_beginDate=$("#beginDate").val(SYSTEM.beginDate);this.$_endDate=$("#endDate").val(SYSTEM.endDate);this.$_matchCon.placeholder();this.$_beginDate.datepicker();this.$_endDate.datepicker();},loadGrid:function(){var b=$(window).height()-$(".grid-wrap").offset().top-65,a=this;var c=[{name:"operating",label:"操作",width:60,fixed:true,formatter:d,align:"center"},{name:"billDate",label:"单据日期",width:100,align:"center"},{name:"billNo",label:"单据编号",width:120,align:"center"},{name:"transType",label:"业务类型",width:100,align:"center"},{name:"customerName",label:"客户名称",width:200},{name:"supplierName",label:"供应商名称",width:200},{name:"hxAmount",label:"核销金额",width:100,align:"right",formatter:"currency"},{name:"userName",label:"制单人",width:80,fixed:true,align:"center",title:false},{name:"description",label:"备注",width:200,classes:"ui-ellipsis"}];queryConditions.beginDate=this.$_beginDate.val();queryConditions.endDate=this.$_endDate.val();a.markRow=[];this.mod_PageConfig.gridReg("grid",c);c=this.mod_PageConfig.conf.grids.grid.colModel;$("#grid").jqGrid({url:"/scm/verifica.do?action=list",postData:queryConditions,datatype:"json",autowidth:true,height:b,altRows:true,rownumbers:true,gridview:true,colModel:c,cmTemplate:{sortable:false,title:false},multiselect:true,page:1,sortname:"number",sortorder:"desc",pager:"#page",rowNum:2000,rowList:[300,500,1000],scroll:1,loadonce:true,viewrecords:true,shrinkToFit:false,forceFit:true,jsonReader:{root:"data.rows",records:"data.records",repeatitems:false,id:"id"},loadComplete:function(g){var e=a.markRow.length;if(e>0){for(var f=0;f<e;f++){$("#"+a.markRow[f]).addClass("red");}}},loadError:function(g,e,f){},ondblClickRow:function(g,i,f,h){$("#"+g).find(".ui-icon-pencil").trigger("click");},resizeStop:function(e,f){THISPAGE.mod_PageConfig.setGridWidthByIndex(e,f-1,"grid");}}).navGrid("#page",{edit:false,add:false,del:false,search:false,refresh:false}).navButtonAdd("#page",{caption:"",buttonicon:"ui-icon-config",onClickButton:function(){THISPAGE.mod_PageConfig.config();},position:"last"});function d(h,e,g){var f='<div class="operating" data-id="'+g.id+'"><span class="ui-icon ui-icon-pencil" title="修改"></span><span class="ui-icon ui-icon-trash" title="删除"></span></div>';return f;}},reloadData:function(a){this.markRow=[];$("#grid").jqGrid("setGridParam",{url:"/scm/verifica.do?action=list",datatype:"json",postData:a}).trigger("reloadGrid");},addEvent:function(){var a=this;$(".grid-wrap").on("click",".ui-icon-pencil",function(d){d.preventDefault();var c=$(this).parent().data("id");parent.tab.addTabItem({tabid:"money-verifica",text:"核销单",url:"/money/verification.jsp?id="+c});var b=$("#grid").jqGrid("getDataIDs");parent.salesListIds=$("#grid").jqGrid("getDataIDs");});$(".grid-wrap").on("click",".ui-icon-trash",function(c){c.preventDefault();if(!Business.verifyRight("VERIFICA_DELETE")){return;}var b=$(this).parent().data("id");$.dialog.confirm("您确定要删除该核销单吗？",function(){Public.ajaxPost("/scm/verifica.do?action=delete",{id:b},function(f){if(f.status===200&&f.msg&&f.msg.length){var d="<p>操作成功！</p>";for(var e in f.msg){if(typeof f.msg[e]==="function"){continue;}e=f.msg[e];d+='<p class="'+(e.isSuccess==1?"":"red")+'">核销单［'+e.id+"］删除"+(e.isSuccess==1?"成功！":"失败："+e.msg)+"</p>";}parent.Public.tips({content:d});}else{parent.Public.tips({type:1,content:f.msg});}$("#search").trigger("click");});});});$(".wrapper").on("click","#btn-batchDel",function(d){if(!Business.verifyRight("VERIFICA_DELETE")){d.preventDefault();return;}var c=$("#grid").jqGrid("getGridParam","selarrrow");var b=c.join();if(!b){parent.Public.tips({type:2,content:"请先选择需要删除的项！"});return;}$.dialog.confirm("您确定要删除选中的核销单吗？",function(){Public.ajaxPost("/scm/verifica.do?action=delete",{id:b},function(g){if(g.status===200&&g.msg&&g.msg.length){var e="<p>操作成功！</p>";for(var f in g.msg){if(typeof g.msg[f]==="function"){continue;}f=g.msg[f];e+='<p class="'+(f.isSuccess==1?"":"red")+'">核销单［'+f.id+"］删除"+(f.isSuccess==1?"成功！":"失败："+f.msg)+"</p>";}parent.Public.tips({content:e});}else{parent.Public.tips({type:1,content:g.msg});}$("#search").trigger("click");});});});$("#search").click(function(){queryConditions.matchCon=a.$_matchCon.val()==="请输入单据号或供应商或备注"?"":$.trim(a.$_matchCon.val());queryConditions.beginDate=a.$_beginDate.val();queryConditions.endDate=a.$_endDate.val();THISPAGE.reloadData(queryConditions);});$("#refresh").click(function(){THISPAGE.reloadData(queryConditions);});$("#add").click(function(b){b.preventDefault();if(!Business.verifyRight("VERIFICA_ADD")){return;}parent.tab.addTabItem({tabid:"money-verification",text:"核销单",url:"/scm/verifica.do?action=initVerifica"});});$("#export").click(function(g){if(!Business.verifyRight("VERIFICA_EXPORT")){g.preventDefault();return;}var d=$("#grid").jqGrid("getGridParam","selarrrow");var b=d.join();var h=b?"&id="+b:"";for(var f in queryConditions){if(queryConditions[f]){h+="&"+f+"="+queryConditions[f];}}var c="/scm/verifica.do?action=export"+h;$(this).attr("href",c);});$(window).resize(function(){Public.resizeGrid();});}};$(function(){THISPAGE.init();});