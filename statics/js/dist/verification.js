var curRow,curCol,curArrears,loading,SYSTEM=parent.SYSTEM,VERSION=parent.SYSTEM.siType,billRequiredCheck=SYSTEM.billRequiredCheck;var urlParam=Public.urlParam();var qtyPlaces=Number(parent.SYSTEM.qtyPlaces),pricePlaces=Number(parent.SYSTEM.pricePlaces),amountPlaces=Number(parent.SYSTEM.amountPlaces);var billIdA=initBillIdA=5;var billIdB=initBillIdB=5;var disEditable=urlParam.disEditable;var THISPAGE={init:function(a){this.mod_PageConfig=Public.mod_PageConfig.init("verification");this.loadGrid(a);this.extendFun(a);this.initDom(a);this.initCombo();if(a.id>0&&a.checked){this.disableEdit();}else{this.editable=true;$("#grid").jqGrid("setGridParam",{cellEdit:true});$("#accountGrid").jqGrid("setGridParam",{cellEdit:true});}this.addEvent();},initDom:function(d){var o=this;this.$_customer=$("#customer");this.$_date=$("#date").val(SYSTEM.endDate);this.$_number=$("#number");this.$_transType=$("#transType");this.$_toolTop=$("#toolTop");this.$_toolBottom=$("#toolBottom");this.$_sourceA=$("#sourceA");this.$_sourceB=$("#sourceB");this.$_buIdA=$("#buIdA");this.$_buIdB=$("#buIdB");this.$_userName=$("#userName");this.$_modifyTime=$("#modifyTime");this.$_createTime=$("#createTime");this.$_checkName=$("#checkName");this.$_note=$("#note");this.$_note.placeholder();originalBuIdA=originalData.buIdA;originalBuIdB=originalData.buIdB;var f='<a id="savaAndAdd" class="ui-btn ui-btn-sp mrb">保存并新增</a><a id="save" class="ui-btn">保存</a>';var g='<a id="add" class="ui-btn ui-btn-sp mrb">新增</a><a id="edit" class="ui-btn mrb">保存</a>';var e='<a id="add" class="ui-btn ui-btn-sp mrb">新增</a><b></b></a>';var j="",k="",c="";if(billRequiredCheck){}else{this.$_checkName.parent().hide();}var a='<a class="ui-btn-prev" id="prev" title="上一张"><b></b></a><a class="ui-btn-next" id="next" title="下一张"><b></b></a>';f+=c;this.btn_edit=g;this.btn_audit=j;this.btn_view=e;this.btn_reaudit=k;this.btn_tempSave=c;var b={extraListHtml:"",defaultFlag:false,callback:{onChange:function(r){originalData.buIdA=r.id;o.resetGridA();}}};var n={extraListHtml:"",defaultFlag:false,callback:{onChange:function(r){originalData.buIdB=r.id;o.resetGridB();}}};o.$_buIdA.data("type","customer");o.$_buIdB.data("type","supplier");function p(){originalData.transType=153201;o.$_sourceA.text("选择预收单据");o.$_sourceB.text("选择应收单据");o.$_buIdA.show();o.$_buIdB.hide();$("#standardVersion").show();o.$_buIdA.find("label").text("客户：");o.$_buIdB.find("label").text("供应商：");if(o.$_buIdA.data("type")==="supplier"){o.customerCombo.loadData(function(){return parent.SYSTEM.customerInfo;},0,false);originalData.buIdA=o.customerCombo.getValue();}if(o.$_buIdB.data("type")==="customer"){o.supplierCombo.loadData(function(){return parent.SYSTEM.supplierInfo;},0,false);originalData.buIdB=o.supplierCombo.getValue();}o.$_buIdA.data("type","customer");o.$_buIdB.data("type","supplier");}function m(){originalData.transType=153202;o.$_sourceA.text("选择预付单据");o.$_sourceB.text("选择应付单据");o.$_buIdA.hide();o.$_buIdB.show().removeClass("tr");$("#standardVersion").show();o.$_buIdA.find("label").text("客户：");o.$_buIdB.find("label").text("供应商：");if(o.$_buIdA.data("type")==="supplier"){o.customerCombo.loadData(function(){return parent.SYSTEM.customerInfo;},0,false);originalData.buIdA=o.customerCombo.getValue();}if(o.$_buIdB.data("type")==="customer"){o.supplierCombo.loadData(function(){return parent.SYSTEM.supplierInfo;},0,false);originalData.buIdB=o.supplierCombo.getValue();}o.$_buIdA.data("type","customer");o.$_buIdB.data("type","supplier");}function l(){originalData.transType=153203;o.$_sourceA.text("选择应收单据");o.$_sourceB.text("选择应付单据");o.$_buIdA.show();o.$_buIdB.show().addClass("tr");$("#standardVersion").show();if(o.$_buIdA.data("type")==="supplier"){o.$_buIdA.find("label").text("客户：");o.customerCombo.loadData(function(){return parent.SYSTEM.customerInfo;},0,false);originalData.buIdA=o.customerCombo.getValue();}if(o.$_buIdB.data("type")==="customer"){o.$_buIdB.find("label").text("供应商：");o.supplierCombo.loadData(function(){return parent.SYSTEM.supplierInfo;},0,false);originalData.buIdB=o.supplierCombo.getValue();}o.$_buIdA.data("type","customer");o.$_buIdB.data("type","supplier");}function i(){originalData.transType=153204;o.$_sourceA.text("选择应收单据");o.$_buIdA.find("label").text("转出客户：");o.$_buIdB.find("label").text("转入客户：");o.$_buIdA.show();o.$_buIdB.show().addClass("tr");if(o.$_buIdA.data("type")==="supplier"){o.customerCombo.loadData(function(){return parent.SYSTEM.customerInfo;},0,false);originalData.buIdA=o.customerCombo.getValue();}if(o.$_buIdB.data("type")==="supplier"){o.supplierCombo.loadData(function(){return parent.SYSTEM.customerInfo;},0,false);originalData.buIdB=o.supplierCombo.getValue();}o.$_buIdA.data("type","customer");o.$_buIdB.data("type","customer");$("#standardVersion").hide();}function h(){originalData.transType=153205;o.$_sourceA.text("选择应付单据");o.$_buIdA.find("label").text("转出供应商：");o.$_buIdB.find("label").text("转入供应商：");o.$_buIdA.show();o.$_buIdB.show().addClass("tr");if(o.$_buIdA.data("type")==="customer"){o.customerCombo.loadData(function(){return parent.SYSTEM.supplierInfo;},0,false);originalData.buIdA=o.customerCombo.getValue();}if(o.$_buIdB.data("type")==="customer"){o.supplierCombo.loadData(function(){return parent.SYSTEM.supplierInfo;},0,false);originalData.buIdB=o.supplierCombo.getValue();}o.$_buIdA.data("type","supplier");o.$_buIdB.data("type","supplier");$("#standardVersion").hide();}this.transTypeCombo=this.$_transType.combo({data:[{id:153201,name:"预收冲应收"},{id:153202,name:"预付冲应付"},{id:153203,name:"应收冲应付"},{id:153204,name:"应收转应收"},{id:153205,name:"应付转应付"}],width:112,text:"name",value:"id",defaultSelected:-1,defaultFlag:false,callback:{onChange:function(r){switch(r.id){case 153201:p();break;case 153202:m();break;case 153203:l();break;case 153204:i();break;case 153205:h();break;}o.resetGridA();o.resetGridB();}}}).getCombo();this.customerCombo=Business.billCustomerCombo($("#customer"),b);this.supplierCombo=Business.billSupplierCombo($("#supplier"),n);switch(d.transType){case 153201:p();break;case 153202:m();break;case 153203:l();break;case 153204:i();break;case 153205:h();break;}this.transTypeCombo.selectByValue(d.transType,false);this.$_date.datepicker({onSelect:function(s){var r=s.format("yyyy-MM-dd");THISPAGE.$_number.text("");Public.ajaxPost("/basedata/systemProfile.do?action=generateDocNo",{billType:"VERIFICA",billDate:r},function(t){if(t.status===200){THISPAGE.$_number.text(t.data.billNo);}else{parent.Public.tips({type:1,content:t.msg});}});}});if(d.id>0){this.customerCombo.selectByValue(originalBuIdA,false);this.supplierCombo.selectByValue(originalBuIdB,false);this.$_number.text(d.billNo);this.$_date.val(d.date);d.description&&this.$_note.val(d.description);if(urlParam.flag!=="list"){a="";}if(d.status==="edit"){var q="<span id=groupBtn>"+g+j+"</span>"+a;if(!d.temp){q+=c;}this.$_toolBottom.html(q);if(!d.temp){}}else{if(d.checked){$("#mark").addClass("has-audit");this.$_toolBottom.html('<span id="groupBtn">'+e+k+"</span>"+a);}else{this.$_toolBottom.html('<span id="groupBtn">'+e+"</span>"+a);}}$("#print").on("click",function(r){if(!Business.verifyRight("VERIFICA_PRINT")){r.preventDefault();return;}});this.verificationListIds=parent.verificationListIds||[];this.idPostion=$.inArray(String(d.id),this.verificationListIds);this.idLength=this.verificationListIds.length;if(this.idPostion===0){$("#prev").addClass("ui-btn-prev-dis");}if(this.idPostion===this.idLength-1){$("#next").addClass("ui-btn-next-dis");}this.$_userName.html(d.userName);this.$_modifyTime.html(d.modifyTime).parent().hide();this.$_createTime.html(d.createTime).parent().hide();this.$_checkName.html(d.checkName);}else{originalData.buIdA=o.customerCombo.getValue();originalData.buIdB=o.supplierCombo.getValue();if(billRequiredCheck){this.$_toolBottom.html("<span id=groupBtn>"+f+j+"</span>");}else{this.$_toolBottom.html('<span id="groupBtn">'+f+"</span>");}this.$_userName.html(SYSTEM.realName||"");this.$_modifyTime.parent().hide();this.$_createTime.parent().hide();this.$_checkName.parent().hide();}if(disEditable){THISPAGE.disableEdit();this.$_toolBottom.hide();}},loadGrid:function(f){var a=this;if(f.id){var e=f.entriesA.length,b=billIdA-e-1;if(b>0){for(var d=0;d<b;d++){f.entriesA.push({id:e+d+1});}}else{billIdA=e+1;}}var c=[{name:"operating",label:" ",width:40,fixed:true,formatter:Public.billsOper,align:"center"},{name:"billNo",label:"源单编号",width:150,title:false,classes:"ui-ellipsis"},{name:"transType",label:"业务类别",width:100,title:false},{name:"billDate",label:"单据日期",width:100,title:false,align:"center"},{name:"billPrice",label:"单据金额",width:100,title:false,align:"right",formatter:"currency",formatoptions:{showZero:true,decimalPlaces:amountPlaces}},{name:"hasCheck",label:"已核销金额",width:100,title:false,align:"right",formatter:"currency",formatoptions:{showZero:true,decimalPlaces:amountPlaces}},{name:"notCheck",label:"未核销金额",width:100,title:false,align:"right",formatter:"currency",formatoptions:{showZero:true,decimalPlaces:amountPlaces}},{name:"nowCheck",label:"本次核销金额",width:100,title:false,align:"right",formatter:"currency",formatoptions:{showZero:true,decimalPlaces:amountPlaces},editable:true}];a.mod_PageConfig.gridReg("accountGrid",c,"1");c=a.mod_PageConfig.conf.grids.accountGrid.colModel;$("#accountGrid").jqGrid({data:f.entriesA,datatype:"clientSide",autowidth:true,height:"100%",idPrefix:"ac",rownumbers:true,gridview:true,onselectrow:false,colModel:c,cmTemplate:{sortable:false},shrinkToFit:false,forceFit:true,rowNum:1000,cellEdit:false,cellsubmit:"clientArray",localReader:{root:"rows",records:"records",repeatitems:false,id:"id"},jsonReader:{root:"data.account",records:"records",repeatitems:false,id:"id"},loadComplete:function(l){if(urlParam.id>0){var k=l.rows;for(var j=0,g=k.length;j<g;j++){var h=j+1,m=k[j];if(m.billId===undefined){break;}$("#ac"+h).data("billInfo",m);}}},gridComplete:function(){setTimeout(function(){Public.autoGrid($("#accountGrid"));},10);},afterSaveCell:function(k,i,m,l,h){billIdA=a.newId;if(i=="billNo"){var j=$("#"+k).data("billInfo");if(j){var g=$("#accountGrid").jqGrid("setRowData",k,{transType:j.transType,billDate:j.billDate,billPrice:j.billPrice,hasCheck:j.hasCheck,notCheck:j.notCheck});if(g){a.acTotal(false);}}}if(i=="nowCheck"){a.acTotal(false);}},afterRestoreCell:function(h,i,j,g){billIdA=a.newId;},resizeStop:function(g,h){a.mod_PageConfig.setGridWidthByIndex(g,h,"accountGrid");},loadonce:true,footerrow:true,userData:{billNo:"合计：",billPrice:f.acPrice,hasCheck:f.acHasCheck,notCheck:f.acNotCheck,nowCheck:f.acNowCheck},userDataOnFooter:true,loadError:function(i,g,h){Public.tips({type:1,content:"Type: "+g+"; Response: "+i.status+" "+i.statusText});}});},extendFun:function(e){var a=this;if(e.id){var b=e.entriesB.length,f=initBillIdB-b-1;if(f>0){for(var d=0;d<f;d++){e.entriesB.push({id:b+d+1});}}else{billIdB=b+1;}}var c=[{name:"operating",label:" ",width:40,fixed:true,formatter:Public.billsOper,align:"center"},{name:"billNo",label:"源单编号",width:150,title:false,classes:"ui-ellipsis"},{name:"transType",label:"业务类别",width:100,title:false},{name:"billDate",label:"单据日期",width:100,title:false,align:"center"},{name:"billPrice",label:"单据金额",width:100,title:false,align:"right",formatter:"currency",formatoptions:{showZero:true,decimalPlaces:amountPlaces}},{name:"hasCheck",label:"已核销金额",width:100,title:false,align:"right",formatter:"currency",formatoptions:{showZero:true,decimalPlaces:amountPlaces}},{name:"notCheck",label:"未核销金额",width:100,title:false,align:"right",formatter:"currency",formatoptions:{showZero:true,decimalPlaces:amountPlaces}},{name:"nowCheck",label:"本次核销金额",width:100,title:false,align:"right",formatter:"currency",formatoptions:{showZero:true,decimalPlaces:amountPlaces},editable:true}];a.mod_PageConfig.gridReg("grid",c,"原单");c=a.mod_PageConfig.conf.grids.grid.colModel;$("#grid").jqGrid({data:e.entriesB,datatype:"clientSide",autowidth:true,height:"100%",idPrefix:"so",rownumbers:true,gridview:true,onselectrow:false,colModel:c,cmTemplate:{sortable:false},shrinkToFit:false,forceFit:true,rowNum:1000,cellEdit:false,cellsubmit:"clientArray",localReader:{root:"rows",records:"records",repeatitems:false,id:"id"},jsonReader:{root:"data.entries",records:"records",repeatitems:false,id:"id"},loadComplete:function(l){if(urlParam.id>0){var k=l.rows;for(var j=0,g=k.length;j<g;j++){var h=j+1,m=k[j];if(m.billId===undefined){break;}$("#so"+h).data("billInfo",m);}}},gridComplete:function(){setTimeout(function(){Public.autoGrid($("#grid"));},10);},afterSaveCell:function(k,i,m,l,h){billIdB=a.newId;if(i=="billNo"){var j=$("#"+k).data("billInfo");if(j){var g=$("#grid").jqGrid("setRowData",k,{transType:j.transType,billDate:j.billDate,billPrice:j.billPrice,hasCheck:j.hasCheck,notCheck:j.notCheck});if(g){a.calTotal();}}}if(i=="nowCheck"){a.calTotal(false);}},afterRestoreCell:function(h,i,j,g){billIdB=a.newId;},resizeStop:function(g,h){a.mod_PageConfig.setGridWidthByIndex(g,h,"grid");},loadonce:true,footerrow:true,userData:{billNo:"合计：",billPrice:e.billPrice,hasCheck:e.billHasCheck,notCheck:e.billNotCheck,nowCheck:e.billNowCheck},userDataOnFooter:true,loadError:function(i,g,h){Public.tips({type:1,content:"Type: "+g+"; Response: "+i.status+" "+i.statusText});}});},reloadData:function(c){$("#grid").clearGridData();var a=this;originalData=c;function f(){a.customerCombo.selectByValue(c.buId,false);a.$_date.val(c.date);a.$_number.text(c.billNo);c.classes==="sales"?a.classes.setValue(0):a.classes.setValue(1);a.$_discountRate.val(c.disRate);a.$_deduction.val(c.disAmount);a.$_discount.val(c.amount);a.$_payment.val(c.rpAmount);a.$_arrears.val(c.arrears);a.$_totalArrears.val(c.totalArrears);c.note&&a.$_note.val(c.note);a.$_userName.html(c.userName);a.$_modifyTime.html(c.modifyTime);a.$_createTime.html(c.createTime);a.$_checkName.html(c.checkName);}var e=4-c.accounts.length;if(e>0){for(var b=0;b<e;b++){c.accounts.push({});}}var d=4-c.entries.length;if(d>0){for(var b=0;b<d;b++){c.entries.push({});}}$("#accountGrid").jqGrid("setGridParam",{data:c.accounts,userData:{accName:"合计：",payment:c.acPayment},cellEdit:true,datatype:"clientSide"}).trigger("reloadGrid");$("#grid").jqGrid("setGridParam",{data:c.entries,userData:{billNo:"合计：",billPrice:c.billPrice,hasCheck:c.billHasCheck,notCheck:c.billNotCheck,nowCheck:c.billNowCheck},cellEdit:true,datatype:"clientSide"}).trigger("reloadGrid");f();if(c.status==="edit"){if(!this.editable){a.enableEdit();$("#groupBtn").html(a.btn_edit+a.btn_audit);}}else{if(this.editable){a.disableEdit();$("#groupBtn").html(a.btn_view+a.btn_reaudit);}}},initCombo:function(){},addEvent:function(){var a=this;this.customerCombo.input.enterKey();this.$_note.enterKey();this.$_date.bind("keydown",function(b){if(b.which===13){$("#grid").jqGrid("editCell",1,2,true);}}).bind("focus",function(b){a.dateValue=$(this).val();}).bind("blur",function(c){var b=/((^((1[8-9]\d{2})|([2-9]\d{3}))(-)(10|12|0?[13578])(-)(3[01]|[12][0-9]|0?[1-9])$)|(^((1[8-9]\d{2})|([2-9]\d{3}))(-)(11|0?[469])(-)(30|[12][0-9]|0?[1-9])$)|(^((1[8-9]\d{2})|([2-9]\d{3}))(-)(0?2)(-)(2[0-8]|1[0-9]|0?[1-9])$)|(^([2468][048]00)(-)(0?2)(-)(29)$)|(^([3579][26]00)(-)(0?2)(-)(29)$)|(^([1][89][0][48])(-)(0?2)(-)(29)$)|(^([2-9][0-9][0][48])(-)(0?2)(-)(29)$)|(^([1][89][2468][048])(-)(0?2)(-)(29)$)|(^([2-9][0-9][2468][048])(-)(0?2)(-)(29)$)|(^([1][89][13579][26])(-)(0?2)(-)(29)$)|(^([2-9][0-9][13579][26])(-)(0?2)(-)(29)$))/;if(!b.test($(this).val())){parent.Public.tips({type:2,content:"日期格式有误！如：2012-08-08。"});$(this).val(a.dateValue);}});$(document).bind("click.cancel",function(b){if(curRow!==null&&curCol!==null){if(!$(b.target).closest("#accountGrid").length>0){$("#accountGrid").jqGrid("saveCell",curRow,curCol);}if(!$(b.target).closest("#grid").length>0){$("#grid").jqGrid("saveCell",curRow,curCol);}}});$("#acGridWrap").on("click",function(){a.newId=billIdA;});$("#billGridWrap").on("click",function(){a.newId=billIdB;});$("#acGridWrap").on("click",".ui-icon-plus",function(g){a.newId=billIdA;var f="ac"+$(this).parent().data("id");var c=$("#accountGrid tbody tr").length;var d={id:a.newId};var b=$("#accountGrid").jqGrid("addRowData",a.newId,d,"after",f);if(b){$(this).parents("td").removeAttr("class");$(this).parents("tr").removeClass("selected-row ui-state-hover");$("#accountGrid").jqGrid("resetSelection");billIdA++;}});$("#acGridWrap").on("click",".ui-icon-trash",function(d){if($("#accountGrid tbody tr").length===2){parent.Public.tips({type:2,content:"至少保留一条分录！"});return false;}var c="ac"+$(this).parent().data("id");var b=$("#accountGrid").jqGrid("delRowData",c);if(b){a.acTotal();a.calTotal();}});$("#billGridWrap").on("click",".ui-icon-plus",function(g){a.newId=billIdB;var f="so"+$(this).parent().data("id");var c=$("#grid tbody tr").length;var d={id:a.newId};var b=$("#grid").jqGrid("addRowData",a.newId,d,"after",f);if(b){$(this).parents("td").removeAttr("class");$(this).parents("tr").removeClass("selected-row ui-state-hover");$("#grid").jqGrid("resetSelection");billIdB++;}});$("#billGridWrap").on("click",".ui-icon-trash",function(d){if($("#grid tbody tr").length===2){parent.Public.tips({type:2,content:"至少保留一条分录！"});return false;}var c="so"+$(this).parent().data("id");var b=$("#grid").jqGrid("delRowData",c);if(b){a.calTotal();}});$(".wrapper").on("click","#save",function(d){d.preventDefault();var c=$(this);if(c.hasClass("ui-btn-dis")){parent.Public.tips({type:2,content:"正在保存，请稍后..."});return;}else{if(!Business.verifyRight("VERIFICA_ADD")){return;}var b=THISPAGE.getPostData();if(b){if(originalData.stata==="edit"){b.id=originalData.id;b.stata="edit";}c.addClass("ui-btn-dis");Public.ajaxPost("/scm/verifica.do?action=add",{postData:JSON.stringify(b)},function(e){c.removeClass("ui-btn-dis");if(e.status===200){a.$_modifyTime.html((new Date()).format("yyyy-MM-dd hh:mm:ss"));a.$_createTime.html((new Date()).format("yyyy-MM-dd hh:mm:ss"));originalData.id=e.data.id;if(billRequiredCheck){a.$_toolBottom.html('<span id="groupBtn">'+a.btn_edit+a.btn_audit+"</span>");}else{a.$_toolBottom.html('<span id="groupBtn">'+a.btn_edit+"</span>");}parent.Public.tips({content:"保存成功！"});}else{parent.Public.tips({type:1,content:e.msg});}});}}});$(".wrapper").on("click","#edit",function(c){c.preventDefault();if(!Business.verifyRight("VERIFICA_UPDATE")){return;}var b=THISPAGE.getPostData();if(b){Public.ajaxPost("/scm/verifica.do?action=updateVerifica",{postData:JSON.stringify(b)},function(d){if(d.status===200){a.$_modifyTime.html((new Date()).format("yyyy-MM-dd hh:mm:ss"));originalData.id=d.data.id;parent.Public.tips({content:"修改成功！"});}else{parent.Public.tips({type:1,content:d.msg});}});}});$(".wrapper").on("click","#savaAndAdd",function(d){d.preventDefault();var c=$(this);if(c.hasClass("ui-btn-dis")){parent.Public.tips({type:2,content:"正在保存，请稍后..."});return;}else{if(!Business.verifyRight("VERIFICA_ADD")){return;}var b=THISPAGE.getPostData();if(b){c.addClass("ui-btn-dis");Public.ajaxPost("/scm/verifica.do?action=addNew",{postData:JSON.stringify(b)},function(f){c.removeClass("ui-btn-dis");if(f.status===200){a.$_number.text(f.data.billNo);$("#accountGrid").clearGridData(true);for(var e=1;e<=4;e++){$("#accountGrid").jqGrid("addRowData",e,{});}billIdA=5;if(VERSION===2){$("#grid").clearGridData(true);for(var e=1;e<=4;e++){$("#grid").jqGrid("addRowData",e,{});}}a.$_note.val("");parent.Public.tips({content:"保存成功！"});}else{parent.Public.tips({type:1,content:f.msg});}});}}});$(".wrapper").on("click","#add",function(b){b.preventDefault();if(!Business.verifyRight("VERIFICA_ADD")){return;}parent.tab.overrideSelectedTabItem({tabid:"money-verification",text:"核销单",url:"/scm/verifica.do?action=initVerifica"});});$("#bottomField").on("click","#prev",function(b){b.preventDefault();if($(this).hasClass("ui-btn-prev-dis")){parent.Public.tips({type:2,content:"已经没有上一张了！"});return false;}else{a.idPostion=a.idPostion-1;if(a.idPostion===0){$(this).addClass("ui-btn-prev-dis");}if(!a.idPostion){return;}loading=$.dialog.tips("数据加载中...",1000,"loading.gif",true);Public.ajaxGet("/scm/verifica.do?action=update",{id:a.verificationListIds[a.idPostion]},function(c){THISPAGE.reloadData(c.data);$("#next").removeClass("ui-btn-next-dis");if(loading){loading.close();}});}});$("#bottomField").on("click","#next",function(b){b.preventDefault();if($(this).hasClass("ui-btn-next-dis")){parent.Public.tips({type:2,content:"已经没有下一张了！"});return false;}else{a.idPostion=a.idPostion+1;if(a.idLength===a.idPostion+1){$(this).addClass("ui-btn-next-dis");}if(!a.idPostion){return;}loading=$.dialog.tips("数据加载中...",1000,"loading.gif",true);Public.ajaxGet("/scm/verifica.do?action=update",{id:a.verificationListIds[a.idPostion]},function(c){THISPAGE.reloadData(c.data);$("#prev").removeClass("ui-btn-prev-dis");if(loading){loading.close();}});}});$("#sourceA").on("click",function(){var e=originalData.transType;switch(e){case 153201:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个客户！"});return false;}else{var c=originalData.buIdA;var b="/scm/verifica.do?action=findPreList&buId="+c+"&transType="+e+"&id="+originalData.id;}break;case 153202:if(originalData.buIdB<=0){parent.Public.tips({type:1,content:"请先选择一个供应商！"});return false;}else{var c=originalData.buIdB;var b="/scm/verifica.do?action=findPreList&buId="+c+"&transType="+e+"&id="+originalData.id;}break;case 153203:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个客户！"});return false;}else{var c=originalData.buIdA;var b="/scm/invSa.do?action=findUnhxList&buId="+c+"&transType="+e+"&id="+originalData.id;}break;case 153204:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个转出客户！"});return false;}else{var c=originalData.buIdA;var b="/scm/verifica.do?action=findPayRecList&buId="+c+"&transType="+e+"&id="+originalData.id;}break;case 153205:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个转出供应商！"});return false;}else{var c=originalData.buIdA;var b="/scm/verifica.do?action=findPayRecList&buId="+c+"&transType="+e+"&id="+originalData.id;}break;}var d=$("#accountGrid");$.dialog({width:765,height:510,title:"选择源单",content:"url:/money/select-source.jsp",data:{url:b},lock:true,ok:function(){setFilterA(this.content,d);},cancel:true});});$("#sourceB").on("click",function(){var e=originalData.transType;switch(e){case 153201:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个客户！"});return false;}else{var c=originalData.buIdA;var b="/scm/invSa.do?action=findUnhxList&buId="+c+"&transType="+e+"&id="+originalData.id;}break;case 153202:if(originalData.buIdB<=0){parent.Public.tips({type:1,content:"请先选择一个供应商！"});return false;}else{var c=originalData.buIdB;var b="/scm/invPu.do?action=findUnhxList&buId="+c+"&transType="+e+"&id="+originalData.id;}break;case 153203:if(originalData.buIdB<=0){parent.Public.tips({type:1,content:"请先选择一个供应商！"});return false;}else{var c=originalData.buIdB;var b="/scm/invPu.do?action=findUnhxList&buId="+c+"&transType="+e+"&id="+originalData.id;}break;break;case 153204:break;default:x="Looking forward to the Weekend";}var d=$("#grid");$.dialog({width:765,height:510,title:"选择源单",content:"url:/money/select-source.jsp",data:{url:b},lock:true,ok:function(){setFilter(this.content,d);},cancel:true});});$("#config").show().click(function(b){a.mod_PageConfig.config();});$(window).resize(function(b){Public.autoGrid($("#grid"));Public.autoGrid($("#accountGrid"));});},resetData:function(){var a=this;$("#grid").clearGridData();for(var b=1;b<=8;b++){$("#grid").jqGrid("addRowData",b,{});$("#grid").jqGrid("footerData","set",{qty:0,amount:0});}a.$_note.val("");a.$_discountRate.val(originalData.disRate);a.$_deduction.val(originalData.disAmount);a.$_discount.val(originalData.amount);a.$_payment.val(originalData.rpAmount);a.$_arrears.val(originalData.arrears);},disableEdit:function(){this.$_date.attr("disabled","disabled").addClass("ui-input-dis");this.$_note.attr("disabled","disabled").addClass("ui-input-dis");$("#grid").jqGrid("setGridParam",{cellEdit:false});$("#accountGrid").jqGrid("setGridParam",{cellEdit:false});this.editable=false;},enableEdit:function(){if(disEditable){return;}this.$_date.removeAttr("disabled").removeClass("ui-input-dis");this.$_note.removeAttr("disabled").removeClass("ui-input-dis");this.editable=true;},acTotal:function(h){var k=this;var a=$("#accountGrid").jqGrid("getDataIDs");var c=0,j=0,g=0,e=0;for(var d=0,f=a.length;d<f;d++){var b=a[d];var l=$("#accountGrid").jqGrid("getRowData",b);if(h!==false){if(l.billPrice){c+=parseFloat(l.billPrice);}if(l.hasCheck){j+=parseFloat(l.hasCheck);}if(l.notCheck){g+=parseFloat(l.notCheck);}$("#accountGrid").jqGrid("footerData","set",{billPrice:c,hasCheck:j,notCheck:g});}if(l.nowCheck){e+=parseFloat(l.nowCheck);}}$("#accountGrid").jqGrid("footerData","set",{nowCheck:e});},calTotal:function(h){var k=this;var a=$("#grid").jqGrid("getDataIDs");var c=0,j=0,g=0,e=0;for(var d=0,f=a.length;d<f;d++){var b=a[d];var l=$("#grid").jqGrid("getRowData",b);if(h!==false){if(l.billPrice){c+=parseFloat(l.billPrice);}if(l.hasCheck){j+=parseFloat(l.hasCheck);}if(l.notCheck){g+=parseFloat(l.notCheck);}$("#grid").jqGrid("footerData","set",{billPrice:c,hasCheck:j,notCheck:g});}if(l.nowCheck){e+=parseFloat(l.nowCheck);}}$("#grid").jqGrid("footerData","set",{nowCheck:e});},resetGridA:function(){$("#accountGrid").clearGridData(true);for(var a=1;a<initBillIdA;a++){$("#accountGrid").jqGrid("addRowData",a,{});}$("#accountGrid").jqGrid("footerData","set",{billNo:"合计：",billPrice:0,hasCheck:0,notCheck:0,nowCheck:0});billIdA=initBillIdA;},resetGridB:function(){$("#grid").clearGridData(true);for(var a=1;a<initBillIdB;a++){$("#grid").jqGrid("addRowData",a,{});}$("#grid").jqGrid("footerData","set",{billNo:"合计：",billPrice:0,hasCheck:0,notCheck:0,nowCheck:0});billIdB=initBillIdB;},_getAccountsData:function(){var f=[];var e=$("#accountGrid").jqGrid("getDataIDs");for(var d=0,b=e.length;d<b;d++){var h=e[d],a;var g=$("#accountGrid").jqGrid("getRowData",h);if(g.billNo===""){continue;}var c=$("#"+h).data("billInfo");a={billId:c.billId,billNo:delHtmlTag(c.billNo),billType:c.billType,transType:c.transType,billDate:c.billDate,billPrice:c.billPrice,hasCheck:c.hasCheck,notCheck:c.notCheck,nowCheck:g.nowCheck};f.push(a);}return f;},_getEntriesData:function(){var f=[];var e=$("#grid").jqGrid("getDataIDs");for(var d=0,b=e.length;d<b;d++){var h=e[d],a;var g=$("#grid").jqGrid("getRowData",h);if(g.billNo===""){continue;}var c=$("#"+h).data("billInfo");a={billId:c.billId,billNo:delHtmlTag(c.billNo),billType:c.billType,transType:c.transType,billDate:c.billDate,billPrice:c.billPrice,hasCheck:c.hasCheck,notCheck:c.notCheck,nowCheck:g.nowCheck};f.push(a);}return f;},getPostData:function(){var a=this;if(curRow!==null&&curCol!==null){$("#grid").jqGrid("saveCell",curRow,curCol);$("#accountGrid").jqGrid("saveCell",curRow,curCol);curRow=null;curCol=null;}var b={};var h=originalData.transType;b.transType=h;var g=$("#accountGrid").jqGrid("footerData","get").nowCheck.replace(/,/g,"");var f=$("#grid").jqGrid("footerData","get").nowCheck.replace(/,/g,"");switch(h){case 153201:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个客户！"});return false;}else{if(g!==f){parent.Public.tips({type:2,content:"核销金额合计要相等！"});return false;}b.buIdA=originalData.buIdA;b.buNameA=a.customerCombo.getText();}break;case 153202:if(originalData.buIdB<=0){parent.Public.tips({type:1,content:"请先选择一个供应商！"});return false;}else{if(g!==f){parent.Public.tips({type:2,content:"核销金额合计要相等！"});return false;}b.buIdB=originalData.buIdB;b.buNameB=a.supplierCombo.getText();}break;case 153203:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个客户！"});return false;}if(originalData.buIdB<=0){parent.Public.tips({type:1,content:"请先选择一个供应商！"});return false;}if(g!==f){parent.Public.tips({type:2,content:"核销金额合计要相等！"});return false;}b.buIdA=originalData.buIdA;b.buNameA=a.customerCombo.getText();b.buIdB=originalData.buIdB;b.buNameB=a.supplierCombo.getText();break;case 153204:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个转出客户！"});return false;}if(originalData.buIdB<=0){parent.Public.tips({type:1,content:"请先选择一个转入客户！"});return false;}b.buIdA=originalData.buIdA;b.buNameA=a.customerCombo.getText();b.buIdB=originalData.buIdB;b.buNameB=a.supplierCombo.getText();break;case 153205:if(originalData.buIdA<=0){parent.Public.tips({type:1,content:"请先选择一个转出供应商！"});return false;}if(originalData.buIdB<=0){parent.Public.tips({type:1,content:"请先选择一个转入供应商！"});return false;}b.buIdA=originalData.buIdA;b.buNameA=a.customerCombo.getText();b.buIdB=originalData.buIdB;b.buNameB=a.supplierCombo.getText();break;}var e=this._getAccountsData();if(e.length===0){parent.Public.tips({type:2,content:"单据内容不能为空！"});$("#accountGrid").jqGrid("editCell",1,2,true);return false;}if(h===153201||h===153202||h===153203){var c=this._getEntriesData();if(c.length===0){parent.Public.tips({type:2,content:"单据内容不能为空！"});$("#billGridWrap").jqGrid("editCell",1,2,true);return false;}}else{var c=[];}var d=$.trim(a.$_note.val());b.id=originalData.id;b.date=$.trim(a.$_date.val());b.billNo=$.trim(a.$_number.text());b.entriesA=e;b.entriesB=c;b.description=note===a.$_note[0].defaultValue?"":d;return b;}};var hasLoaded=false,originalData;$(function(){if(!urlParam.id){originalData={id:-1,status:"add",transType:153201,buIdA:0,buIdB:0,entriesA:[{id:"1"},{id:"2"}],acPrice:0,acHasCheck:0,acNotCheck:0,acNowCheck:0,entriesB:[{id:"1"},{id:"2"},{id:"3"}],billPrice:0,billHasCheck:0,billNotCheck:0,billNowCheck:0};THISPAGE.init(originalData);}else{if(!hasLoaded){var a=$(".bills").hide();Public.ajaxGet("/scm/verifica.do?action=update",{id:urlParam.id},function(b){if(b.status===200){originalData=b.data;THISPAGE.init(b.data);a.show();hasLoaded=true;}else{parent.Public.tips({type:1,content:b.msg});}});}else{}}});function setFilterA(b,e){var c=b.$("#grid").jqGrid("getGridParam","selarrrow"),g=c.length,m=[];var d=e.jqGrid("getDataIDs"),j=d.length,f;for(var l=0;l<j;l++){var h=$("#"+d[l]).data("billInfo");if(h){}else{f=d[l];break;}}var i=j-l;var k=g-i;if(f===undefined){f="ac"+billIdA;}if(k>0){var a=[];while(k){a.push({id:billIdA});k--;billIdA++;}$("#accountGrid").jqGrid("addRowData","id",a,"after",f);}if(g>0){$.each(c,function(n,p){var o=b.$("#grid").jqGrid("getRowData",p);o.nowCheck=o.notCheck;THISPAGE.calTotal(false);$("#accountGrid").jqGrid("setRowData",f,o);f=$("#"+f).data("billInfo",o).next().attr("id");});}THISPAGE.acTotal();}function delHtmlTag(a){return a.replace(/<[^>]+>/g,"");}function setFilter(b,e){var c=b.$("#grid").jqGrid("getGridParam","selarrrow"),g=c.length,m=[];var d=e.jqGrid("getDataIDs"),j=d.length,f;for(var l=0;l<j;l++){var h=$("#"+d[l]).data("billInfo");if(h){}else{f=d[l];break;}}var i=j-l;var k=g-i;if(f===undefined){f="so"+billIdB;}if(k>0){var a=[];while(k){a.push({id:billIdB});k--;billIdB++;}$("#grid").jqGrid("addRowData","id",a,"after",f);}if(g>0){$.each(c,function(n,p){var o=b.$("#grid").jqGrid("getRowData",p);o.nowCheck=o.notCheck;$("#grid").jqGrid("setRowData",f,o);f=$("#"+f).data("billInfo",o).next().attr("id");});}THISPAGE.calTotal(false);}